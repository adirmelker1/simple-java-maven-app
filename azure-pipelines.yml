# Starter pipeline for Windows-based Agent
trigger:
  - none
pr:
  - none

pool:
  name: "Default"

variables:
  - name: IMAGE_TAG
    value: "latest"
  - name: acr_server
    value: "adirdevopsregistry2026.azurecr.io"
  - name: image_name
    value: "my-app"
  - name: service_connection
    value: "ACR"

jobs:
  - job: DeployAndVerify
    displayName: "Deploy to Production"
    steps:
      # 1. התחברות ל-Azure Container Registry
      - task: Docker@2
        displayName: "Login to ACR"
        inputs:
          containerRegistry: "$(service_connection)"
          command: "login"

      # 2. פריסת הקונטיינר בתחביר שמתאים ל-Windows CMD
      - script: |
          echo "Cleaning old container..."
          :: השתקת שגיאות ב-Windows במידה והקונטיינר לא קיים
          docker stop $(image_name) >nul 2>&1
          docker rm $(image_name) >nul 2>&1

          echo "Pulling latest image..."
          docker pull $(acr_server)/$(image_name):$(IMAGE_TAG)

          echo "Starting new container..."
          :: שימוש ב-^ להמשך שורה ב-Windows
          docker run -d ^
            --name $(image_name) ^
            -p 8080:8080 ^
            $(acr_server)/$(image_name):$(IMAGE_TAG)
        displayName: "Deploy Docker Container"

      # 3. הצגת פלט האפליקציה (Logs)
      - script: |
          echo "Waiting 5 seconds for application to start..."
          timeout /t 5 /nobreak >nul
          echo "--- Application Output (Logs) ---"
          docker logs $(image_name)
          echo "---------------------------------"
          echo "Current status:"
          docker ps --filter "name=$(image_name)"
        displayName: "Fetch Application Logs and Status"